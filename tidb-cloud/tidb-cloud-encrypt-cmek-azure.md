---
title: Encryption at Rest Using Customer-Managed Encryption Keys on Azure
summary: Learn how to use a Customer-Managed Encryption Key (CMEK) on Azure in TiDB Cloud.
---

# Encryption at Rest Using Customer-Managed Encryption Keys on Azure

Customer-Managed Encryption Key (CMEK) allows you to secure your static data in a TiDB Cloud Dedicated cluster by utilizing a symmetric encryption key that is under your complete control. This key is referred to as the CMEK key.

Once CMEK is enabled for a project, all clusters created within that project encrypt their static data using the CMEK key. Additionally, any backup data generated by these clusters is encrypted using the same key. If CMEK is not enabled, TiDB Cloud employs an escrow key to encrypt all data in your cluster when it is at rest.

## Restrictions

- Currently, TiDB Cloud only supports using AWS KMS and Azure Key Vault to provide CMEK.
- To use CMEK, you need to enable CMEK when creating a project and complete CMEK-related configurations before creating a cluster. You cannot enable CMEK for existing projects.
- Currently, in CMEK-enabled projects, you can only create [TiDB Cloud Dedicated](/tidb-cloud/select-cluster-tier.md#tidb-cloud-dedicated) clusters hosted on AWS and Azure.
- Currently, in CMEK-enabled projects, [dual region backup](/tidb-cloud/backup-and-restore-concepts.md#dual-region-backup) is not supported.
- Currently, in CMEK-enabled projects, you can enable CMEK on AWS and Azure. Each cloud provider allows configuring a unique encryption key per region. Clusters may only be created in regions where an encryption key has been configured for the selected cloud provider.

## Enable CMEK

If you want to encrypt your data using the encryption keys owned by your account, take the following steps.

### Step 1. Create a CMEK-enabled project

If you are in the `Organization Owner` role of your organization, you can create a CMEK-enabled project using either the TiDB Cloud console or API.

To create a CMEK-enabled project, take the following steps:

1. In the [TiDB Cloud console](https://tidbcloud.com), switch to your target organization using the combo box in the upper-left corner.
2. In the left navigation pane, click **Projects**.
3. On the **Projects** page, click **Create New Project** in the upper-right corner.
4. Fill in a project name.
5. Choose to enable the CMEK capability of the project.
6. Click **Confirm** to complete the project creation.

### Step 2. Complete the CMEK configuration of the project

You can complete the CMEK configuration of the project using the TiDB Cloud console.

> **Note:**
>
> Make sure that the policy of the key meets the requirements and is free from errors such as insufficient permissions or account issues. These errors can cause clusters to be incorrectly created using this key.

To complete the CMEK configuration for Azure Key Vault of the project, take the following steps:

> **Note:**
>
> The cross-tenant customer-managed key (CMK) feature for Azure managed disks is currently in preview and only available in select Azure regions. Currently, only availability regions are supported. Learn more about [Encrypt managed disks with cross-tenant customer-managed keys](https://learn.microsoft.com/en-us/azure/virtual-machines/disks-cross-tenant-customer-managed-keys?tabs=azure-portal#preview-regional-availability).

<SimpleTab groupId="method">

<div label="Use Console" value="console">

1. In the [TiDB Cloud console](https://tidbcloud.com/), switch to your target project using the combo box in the upper-left corner.

2. In the left navigation pane, click **Project Settings** > **Encryption Access**.

3. On the **Encryption Access** page, click **Create Encryption Key** to enter the key creation page.

4. Choose **Key Management Service** as **Azure Key Vault**. You can choose the region where the encryption key can be used.

5. Create a Service Principal for the TiDB-provided Enterprise Application if you do not already have one in your tenant. For more information, refer to [Application and service principal objects in Microsoft Entra ID](https://learn.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals). To create the Service Principal, run the following command as shown in the **Create Service Principal** section:

   ```
   az ad sp create --id {Microsoft_Entra_Application_ID}
   ```

6. Create a **Key Vault** in your Azure account, or use an existing one. 

   * Make sure **purge protection is enabled** on the Key Vault.
   * The **region** must match the cluster's region.

7. Provide your Key Vault name and Key name prefix in the TiDB Cloud console. A unique suffix will be added to the key name for enhanced security. Copy the full key name and create a new encryption key in the Key Vault in the Azure portal. For more information, refer to [Create your encryption key](https://learn.microsoft.com/azure/key-vault/keys/quick-create-portal).

8. Assign the **Key Vault Crypto Officer** role to your current user for the Key Vault.

   * In the Azure Portal, navigate to your Key Vault.
   * Click on **Access control (IAM)**, then select **Add** > **Add role assignment**.
   * Search for and select the **Key Vault Crypto Officer** role, then click **Next**.
   * On the **Members** tab, set **Assign access to** as **User, group, or service principal**.
   * Click **+ Select members**, then search for and select your current user as the member. Click **Select** to confirm.
   * Review the settings and click **Review + assign** to complete the role assignment.

9. Assign the **Key Vault Crypto Service Encryption User** role to the TiDB-provided enterprise application for the encryption key.

   * Go to the specific encryption key object you created in your Key Vault.
   * Click **Add role assignment** in the **Add** dropdown button.
   * Search for and select the **Key Vault Crypto Service Encryption User** role, then click **Next**.
   * On the **Members** tab, choose **Assign access to**: **User, group, or service principal**.
   * Click **+ Select members**. In the search box, enter the TiDB-provided **Enterprise Application Name** and select it as the member. Click **Select** to confirm your choice.
   * Review the configuration and click **Review + assign** to complete the role assignment.
   
10. Click **Test Encryption Key and Create** in the TiDB Cloud console to validate the configuration and create the encryption key.
    </div>
<div label="Use Azure Resource Manager" value="arm">

1. In the [TiDB Cloud console](https://tidbcloud.com/), use the combo box in the upper-left corner to switch to your target project.

2. In the left navigation panel, go to **Project Settings** > **Encryption Access**.

3. On the **Encryption Access** page, click **Create Encryption Key** to start the key creation process.

4. Under **Key Management Service**, select **Azure Key Vault**. You can also specify the region where the encryption key will be available.

5. If you do not already have a Service Principal for the TiDB-provided Enterprise Application in your tenant, create one. For more information, see [Application and service principal objects in Microsoft Entra ID](https://learn.microsoft.com/azure/active-directory/develop/app-objects-and-service-principals). To create the Service Principal, run the following command as described in the **Create Service Principal** section:

   ```
   az ad sp create --id {Microsoft_Entra_Application_ID}
   ```

6. Open the [Azure Resource Manager with the TiDB custom deployment template](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Ftcidm.blob.core.windows.net%2Fcmek%2Fazure_cmek_rmt.json%3Fsv%3D2015-04-05%26ss%3Db%26srt%3Dco%26sp%3Drl%26se%3D2029-03-01T00%3A00%3A01.0000000Z%26sig%3DIA02CymcFpYCwoTsqCSJVD%2F8Khh%2F0UAPrkKDeLMIIFc%3D) in the Azure Portal. Choose your **Subscription** and **Resource Group**, then fill out the **Instance Details** section as follows:

   - **Region**: Select the location where the key vault will be created. This must match your clusterâ€™s region.
   - **Key Vault Name**: Enter the name of your Azure Key Vault.
   - **Key Name**: Provide the full key name to be created in the key vault. In the TiDB console, enter the key name prefix and use the **Copy** icon to obtain the full key name.
   - **Enterprise App Service Principal Id**: Enter the Service Principal ID for the TiDB-managed enterprise application. To retrieve the **Service Principal ID**, run (replace `{microsoft_enterprise_app_id}` with the actual ID shown in the TiDB Cloud console):
     
     ```shell
     az ad sp show --id {microsoft_enterprise_app_id} --query id -o tsv
     ```

</div>
</SimpleTab>



> **Note:**
>
> This feature will be further enhanced in the future, and upcoming features might require additional permissions. Therefore, this policy requirement is subject to change.

### Step 3. Create a cluster

Under the project created in [Step 1](#step-1-create-a-cmek-enabled-project), create a TiDB Cloud Dedicated cluster hosted on AWS or Azure. For detailed steps, refer to [this document](/tidb-cloud/create-tidb-cluster.md). Once you select a cloud provider and region, the appropriate encryption key will be automatically matched. If no key is available for your chosen provider and region, an informational tip will appear to help you create a new one.

> **Note:**
>
> When CMEK is enabled, the Premium SSD v2 used by the cluster nodes and the storage blob for cluster backups are encrypted using CMEK.

## Rotate CMEK

You can [configure cryptographic key auto-rotation in Azure Key Vault](https://learn.microsoft.com/en-us/azure/key-vault/keys/how-to-configure-key-rotation). With this rotation enabled, you do not need to update **Encryption Access** in project settings in TiDB Cloud.

## Disable and Enable CMEK

If you need to temporarily revoke TiDB Cloud's access to CMEK, follow these steps:

1. On the TiDB Cloud console, pause the corresponding clusters in the project.
2. On the Azure Key Vault console, right-click on the encryption key and select **Disable**.

> **Note:**
>
> After you disabling CMEK on Azure Key Vault, your running clusters are not affected. However, if you pause a cluster and then try to resume it, the cluster will not be able to resume because it cannot access CMEK.

After disabling TiDB Cloud's access to CMEK, if you need to restore the access, follow these steps:

1. On the Azure Key Vault console, select the encryption key and click **Enable**.
2. On the TiDB Cloud console, restore the corresponding clusters in the project.